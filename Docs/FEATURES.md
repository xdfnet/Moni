# Moni 功能特性文档

## 概述

本文档详细描述了 Moni 项目的所有功能特性，包括核心功能、新增功能、技术特性和用户体验改进。

## 核心功能

### 1. AI 服务延迟监控

#### 功能描述
实时监控 AI 服务（如 Claude、Gemini、DeepSeek、Kimi）的网络延迟，帮助用户了解服务可用性和网络质量。

#### 技术实现
- 使用 Network.framework 建立 TCP 连接
- 测量连接建立时间作为延迟指标
- 支持自定义端点和端口配置
- 智能重试机制和错误恢复

#### 监控指标
- **连接延迟**：从发起连接到建立成功的时间
- **成功率**：成功连接次数占总尝试次数的比例
- **响应时间**：网络层面的响应速度

#### 支持的服务
- **Claude**：Anthropic 的 AI 服务
- **Gemini**：Google 的 AI 服务
- **DeepSeek**：DeepSeek 的 AI 服务
- **Kimi**：Moonshot 的 AI 服务

### 2. 网络流量监控

#### 功能描述
监控系统网络接口的实时流量，计算下载速度，帮助用户了解网络使用情况。

#### 技术实现
- 使用 sysctl 系统调用获取网络统计信息
- 计算单位时间内的数据流量变化
- 支持多种网络接口监控
- 数据有效性验证和异常检测

#### 监控指标
- **下载速度**：实时网络下载速率（MB/s）
- **流量统计**：累计接收的数据量
- **网络状态**：网络接口的可用性

#### 数据验证
- 检测网络接口重置事件
- 过滤不合理的速度值
- 自动恢复异常状态

### 3. 菜单栏集成

#### 功能描述
轻量级的菜单栏应用，不占用 Dock 空间，提供快速访问和实时状态显示。

#### 界面特性
- **状态栏图标**：显示当前监控状态和数值
- **下拉菜单**：提供完整的配置和监控选项
- **实时更新**：动态显示监控结果
- **状态指示器**：健康状态图标和工具提示

#### 交互功能
- **显示模式切换**：LLM（延迟监控）和 Net（网络监控）
- **监控频率调整**：0.5s、1s、2s、5s 可选
- **服务端点选择**：支持多个 AI 服务切换
- **设置持久化**：自动保存用户偏好

## 新增功能 (v1.06)

### 1. 智能重试机制

#### 功能描述
在延迟监控中实现智能重试策略，提高监控的可靠性和用户体验。

#### 技术特性
- **指数退避算法**：重试延迟逐渐增加，避免过度重试
- **抖动机制**：添加随机延迟，减少重试冲突
- **最大重试限制**：防止无限重试，保护系统资源
- **智能状态管理**：区分不同类型的错误，采用不同的重试策略

#### 重试参数
```swift
struct MonitorConstants {
    static let maxRetries = 3                    // 最大重试次数
    static let initialRetryDelay: TimeInterval = 1.0    // 初始重试延迟
    static let maxRetryDelay: TimeInterval = 30.0       // 最大重试延迟
}
```

#### 重试流程
1. 检测到连接失败
2. 判断错误类型和重试条件
3. 计算重试延迟（指数退避 + 抖动）
4. 执行重试操作
5. 记录重试日志和统计信息

### 2. 状态指示器系统

#### 功能描述
在状态栏提供直观的状态指示，让用户快速了解应用的健康状态和监控结果。

#### 状态图标
- **✓ (绿色)**：监控正常，数据有效
- **⚠️ (黄色)**：监控警告，需要关注
- **❌ (红色)**：监控错误，需要处理

#### 工具提示
- **详细状态信息**：显示具体的监控数值和状态
- **错误描述**：用户友好的错误信息
- **建议操作**：提供解决建议

#### 状态管理
- **实时更新**：根据监控结果动态更新状态
- **状态持久化**：保存最后的状态信息
- **状态恢复**：错误后自动恢复到健康状态

### 3. 配置管理系统

#### 功能描述
统一的配置管理，支持配置的读写、验证、导入导出和热重载。

#### 配置项
- **显示模式**：LLM 或 Net 模式选择
- **监控间隔**：监控频率设置
- **服务端点**：选中的 AI 服务
- **通知设置**：是否启用通知
- **重试设置**：最大重试次数
- **超时设置**：连接超时时间

#### 配置特性
- **类型安全**：强类型的配置访问
- **默认值管理**：合理的默认配置
- **配置验证**：输入验证和范围检查
- **变更通知**：配置变更时通知相关组件

#### 配置操作
- **导入配置**：从 JSON 文件导入配置
- **导出配置**：将当前配置导出为 JSON
- **重置配置**：恢复到默认配置
- **配置备份**：自动备份用户配置

### 4. 线程安全改进

#### 功能描述
在基础监控类中添加线程安全保护，确保多线程环境下的数据一致性。

#### 安全机制
- **NSLock 保护**：保护共享状态变量
- **队列隔离**：不同监控器使用独立队列
- **主队列回调**：UI 更新确保在主线程
- **资源管理**：安全的资源分配和释放

#### 线程模型
- **主线程**：UI 更新和用户交互
- **监控队列**：执行监控操作
- **配置队列**：处理配置变更
- **后台队列**：执行耗时操作

### 5. 数据验证增强

#### 功能描述
在网络监控中添加数据有效性检查，提高监控数据的准确性和可靠性。

#### 验证机制
- **网络接口重置检测**：检测网络接口的重新初始化
- **速度值合理性检查**：过滤异常的速度数据
- **数据连续性验证**：确保数据的连续性
- **异常值处理**：自动处理异常数据

#### 验证参数
```swift
struct MonitorConstants {
    static let maxReasonableSpeed: Double = 1000.0              // 最大合理速度（MB/s）
    static let networkStatsResetThreshold: UInt64 = 1000000000  // 网络统计重置阈值
}
```

### 6. 工具函数库

#### 功能描述
丰富的工具函数集合，提供安全转换、性能测量、调试支持等功能。

#### 安全转换工具
- **safeInt**：安全的整数转换
- **safeDouble**：安全的浮点数转换
- **safeString**：安全的字符串转换
- **safeBool**：安全的布尔值转换

#### 性能测量工具
- **measureExecutionTime**：同步函数执行时间测量
- **measureExecutionTimeAsync**：异步函数执行时间测量
- **printPerformanceStats**：性能统计信息打印

#### 调试工具
- **debugPrint**：带上下文信息的调试打印
- **formatError**：错误信息格式化
- **getCallStack**：获取调用栈信息

### 7. 菜单优化

#### 功能描述
优化菜单项名称，使其更专业、更简洁，提升用户体验。

#### 名称变更
- **"Latency" → "LLM"**：更专业的技术术语
- **"Speed" → "Net"**：更简洁的缩写形式

#### 优化效果
- **专业性提升**：使用行业标准术语
- **简洁性改进**：减少菜单项长度
- **一致性增强**：统一的命名风格

### 8. 构建工具重构

#### 功能描述
将 Makefile 重构为模块化设计，支持单独运行任何构建步骤。

#### 模块化设计
- **step-clear**：清理构建环境
- **step-close-app**：关闭运行中的应用
- **step-update-version**：更新版本号
- **step-build-app**：构建应用
- **step-install-app**：安装应用
- **step-cleanup**：清理临时文件
- **step-open-app**：启动应用
- **step-complete**：完成构建流程

#### 构建目标
- **build**：完整构建流程（包含版本号递增）
- **build-fixed**：固定版本构建
- **单独步骤**：支持运行任何单个步骤

#### 优势
- **灵活性**：可以单独运行任何步骤
- **可维护性**：每个步骤独立，易于修改
- **调试友好**：可以定位到具体的失败步骤
- **扩展性**：易于添加新的构建步骤

## 技术特性

### 1. 架构设计

#### 分层架构
- **表现层**：用户界面和交互
- **业务逻辑层**：核心监控功能
- **基础设施层**：通用服务和工具
- **系统层**：操作系统接口

#### 设计模式
- **代理模式**：监控结果回调
- **观察者模式**：状态变化通知
- **策略模式**：不同的监控策略
- **模板方法模式**：监控流程模板
- **单例模式**：配置和服务管理

### 2. 错误处理

#### 错误类型
- **MonitorError**：统一的错误类型定义
- **本地化支持**：用户友好的错误信息
- **错误分类**：按严重程度分类错误

#### 错误恢复
- **自动重试**：智能重试机制
- **降级处理**：错误时的友好提示
- **状态恢复**：自动恢复到正常状态

### 3. 性能优化

#### 资源管理
- **内存管理**：及时释放不需要的资源
- **连接复用**：避免重复建立连接
- **定时器优化**：合理的更新频率

#### 异步处理
- **队列管理**：使用适当的队列优先级
- **非阻塞操作**：避免主线程阻塞
- **并发控制**：合理的并发数量

### 4. 可扩展性

#### 新监控器添加
- 继承 BaseMonitor 基类
- 实现具体的监控逻辑
- 定义相应的代理协议
- 集成到用户界面

#### 新配置项添加
- 在 ConfigurationManager 中定义
- 添加验证逻辑
- 更新用户界面
- 支持配置持久化

## 用户体验

### 1. 界面设计

#### 状态栏显示
- **实时数据**：动态显示监控结果
- **状态指示**：直观的状态图标
- **工具提示**：详细的状态信息

#### 菜单设计
- **层次清晰**：逻辑分组和分隔线
- **操作便捷**：常用功能快速访问
- **状态反馈**：操作结果的即时反馈

### 2. 交互体验

#### 响应性
- **实时更新**：监控数据的实时显示
- **快速响应**：用户操作的即时反馈
- **流畅动画**：平滑的状态转换

#### 易用性
- **直观操作**：符合用户习惯的操作方式
- **智能默认**：合理的默认配置
- **帮助提示**：清晰的操作指导

### 3. 可靠性

#### 稳定性
- **错误恢复**：自动处理常见错误
- **状态持久化**：保存用户设置
- **资源管理**：防止资源泄漏

#### 性能
- **低资源占用**：最小化系统资源使用
- **快速启动**：应用启动时间优化
- **流畅运行**：运行时性能优化

## 配置选项

### 1. 监控配置

#### 监控间隔
- **0.5s**：高频率监控，适合网络测试
- **1s**：标准监控频率，平衡性能和准确性
- **2s**：低频率监控，减少系统资源占用
- **5s**：最低频率，适合长期监控

#### 超时设置
- **连接超时**：网络连接建立超时时间
- **重试次数**：连接失败时的最大重试次数
- **重试延迟**：重试之间的等待时间

### 2. 界面配置

#### 显示选项
- **显示模式**：选择监控信息类型
- **状态指示**：是否显示状态图标
- **工具提示**：是否启用详细提示

#### 通知设置
- **错误通知**：是否显示错误通知
- **状态变更通知**：是否通知状态变化
- **声音提示**：是否启用声音提示

### 3. 高级配置

#### 网络配置
- **网络接口**：选择监控的网络接口
- **代理设置**：配置网络代理
- **防火墙规则**：网络访问权限

#### 日志配置
- **日志级别**：控制日志详细程度
- **日志文件**：日志文件存储位置
- **日志轮转**：日志文件大小限制

## 未来规划

### 1. 短期目标 (1-2 个月)

#### 功能增强
- [ ] 添加更多 AI 服务支持
- [ ] 实现监控数据导出功能
- [ ] 添加网络质量评估指标
- [ ] 优化内存使用和性能

#### 用户体验
- [ ] 改进状态指示器设计
- [ ] 添加键盘快捷键支持
- [ ] 优化错误提示信息
- [ ] 增加操作引导

### 2. 中期目标 (3-6 个月)

#### 高级功能
- [ ] 实现监控数据可视化
- [ ] 添加告警和通知功能
- [ ] 支持自定义监控规则
- [ ] 实现多设备同步

#### 平台扩展
- [ ] 开发 iOS 版本
- [ ] 支持 Apple Watch
- [ ] 添加 Safari 扩展
- [ ] 支持命令行工具

### 3. 长期目标 (6+ 个月)

#### 企业功能
- [ ] 云端数据存储
- [ ] 团队协作功能
- [ ] 企业级部署支持
- [ ] API 接口开放

#### 智能化
- [ ] AI 驱动的网络优化建议
- [ ] 智能故障诊断
- [ ] 预测性维护
- [ ] 自动化配置优化

---

*功能特性文档 - 最后更新：2025年1月*

# 功能特性

## 概述

Moni 是一个功能完整的 macOS 菜单栏网络监控应用，提供 AI 服务延迟监控和系统网络流量监控功能。通过现代化的架构设计和优化的代码结构，为用户提供可靠、高效的网络监控体验。

## 核心功能

### 1. AI 服务延迟监控

#### 功能描述
实时监控各种 AI 服务的网络延迟，通过 TCP 连接建立时间计算网络延迟。

#### 技术特点
- **毫秒级精度**：延迟测量精确到毫秒
- **TCP 连接测试**：使用 Network.framework 建立真实连接
- **超时处理**：内置超时机制，避免长时间等待
- **状态管理**：连接成功/失败两种状态，简洁明了

#### 支持的服务
- **Claude** (api.anthropic.com) - Anthropic 的 AI 助手
- **Gemini** (generativelanguage.googleapis.com) - Google 的 AI 模型
- **DeepSeek** (api.deepseek.com) - DeepSeek 的 AI 服务
- **GLM** (open.bigmodel.cn) - 智谱 AI 的 GLM 模型
- **Kimi** (api.moonshot.cn) - 月之暗面的 AI 助手

#### 监控指标
- 网络延迟（毫秒）
- 连接状态（成功/失败）
- 响应时间统计

### 2. 系统网络流量监控

#### 功能描述
监控系统整体网络流量，计算实时下载速度。

#### 技术特点
- **系统级监控**：通过 sysctl 获取所有网卡数据
- **智能过滤**：只统计活跃的非回环网络接口
- **异常检测**：自动检测网络接口重置和异常数据
- **三位小数精度**：下载速度显示精确到 0.001 MB/s

#### 监控指标
- 实时下载速度（MB/s）
- 网络接口状态
- 流量统计信息

#### 数据验证
- 过滤异常的速度值
- 自动重置网络统计
- 检测网络接口重置

### 3. 智能服务分类

#### 分类体系
- **AI 服务**：各种 AI 模型和服务的 API 端点
- **开发工具**：包管理器和开发相关的服务
- **网络服务**：容器注册表和开发工具服务

#### 服务管理
- 预配置的服务端点
- 可配置的监控参数
- 灵活的服务选择

## 用户界面

### 1. 菜单栏集成

#### 设计理念
- **轻量级**：不占用桌面空间
- **实时更新**：状态信息实时刷新
- **直观显示**：清晰的状态指示

#### 界面元素
- 状态栏图标（连接成功/失败指示）
- 下拉菜单（服务选择、配置选项）
- 实时数据显示（延迟、速度等）

### 2. 状态指示系统

#### 视觉反馈
- **✓ 绿色图标**：连接成功，服务正常
- **⚠️ 橙色图标**：连接失败，需要检查

#### 信息显示
- 当前监控的服务名称
- 实时延迟或网络速度
- 连接状态和健康度

### 3. 配置菜单

#### 显示模式
- **Service**：AI 服务延迟监控模式
- **Network**：系统网络流量监控模式

#### 监控频率
- 0.5 秒：高频监控，适合调试
- 1.0 秒：标准监控，平衡性能和准确性
- 2.0 秒：低频监控，减少系统资源占用
- 5.0 秒：超低频监控，适合长期观察

## 技术特性

### 1. 架构设计

#### 分层架构
- **应用层**：用户界面和生命周期管理
- **业务层**：监控逻辑和数据处理
- **基础设施层**：网络通信和系统调用

#### 设计模式
- **代理模式**：监控结果回调通知
- **观察者模式**：状态变化实时更新
- **模板方法模式**：基础监控流程定义
- **单例模式**：全局服务管理

### 2. 性能优化

#### 异步处理
- **GCD 队列**：专用队列处理监控任务
- **非阻塞操作**：网络操作不阻塞主线程
- **资源管理**：完善的资源清理机制

#### 内存管理
- **弱引用**：避免循环引用
- **自动清理**：连接完成后自动释放资源
- **状态管理**：使用 NSLock 保护共享状态

### 3. 线程安全

#### 并发控制
- **NSLock 保护**：关键资源的线程安全访问
- **专用队列**：配置操作的专用处理队列
- **主线程回调**：统一的 UI 更新机制

#### 状态同步
- 监控状态的原子性更新
- 配置变更的线程安全处理
- 资源清理的同步操作

## 开发工具

### 1. 工具函数库

#### 格式化工具
- **`formatLatency`**：延迟时间格式化（毫秒）
- **`formatSpeed`**：网络速度格式化（MB/s，三位小数）
- **`formatInterval`**：时间间隔格式化

#### 时间工具
- **`currentTimestamp`**：获取当前时间戳
- **`timeDifference`**：计算时间差

#### 线程安全工具
- **`safeMainQueueCallback`**：安全的主线程回调执行
- **`safeMainQueueCallback<T>`**：带 weak self 检查的主线程回调

#### 数值工具
- **`safeInt`**：安全的数值转换
- **`clamp`**：限制数值范围
- **`validateServiceEndpoint`**：验证服务端点配置

#### 性能工具
- **`measureExecutionTime`**：测量代码执行时间

#### 调试工具
- **`debugPrint`**：打印调试信息（包含文件名、行号、函数名）
- **`printPerformanceStats`**：打印性能统计

### 2. 构建系统

#### Makefile 支持
- **`make build`**：完整构建流程
- **`make build-fixed`**：固定版本构建
- **`make clean`**：清理构建文件
- **`make help`**：查看所有可用命令

#### 代码质量检查
- **`make quality-check`**：运行代码质量检查脚本
- 语法检查、格式验证、最佳实践检查

## 系统集成

### 1. macOS 特性支持

#### 系统生命周期
- **应用启动**：自动初始化监控系统
- **系统睡眠**：暂停监控，释放资源
- **系统唤醒**：自动恢复监控状态
- **应用退出**：清理资源，保存配置

#### 权限管理
- 网络访问权限
- 系统监控权限
- 用户配置权限

### 2. 开发环境支持

#### 编辑器配置
- **Cursor**：配置为使用 zsh 终端，支持 Homebrew
- **VSCode**：配置为使用 zsh 终端，统一开发体验

#### 环境变量
- 自动识别 Homebrew 安装的 Python 3.13.7
- 支持 zsh 和 bash 两种 shell
- 环境变量继承和配置

## 扩展性

### 1. 服务端点扩展

#### 添加新服务
- 在 `ServiceManager` 中添加新的服务端点
- 支持自定义的服务分类
- 可配置的监控参数

#### 监控策略扩展
- 继承 `BaseMonitor` 实现新的监控类型
- 支持不同的网络协议和监控方式
- 可扩展的数据处理逻辑

### 2. 用户界面扩展

#### 菜单扩展
- 添加新的配置选项
- 支持自定义的显示模式
- 可扩展的状态指示器

#### 数据展示扩展
- 支持图表和统计信息
- 可配置的数据导出格式
- 支持历史数据查看

## 性能指标

### 1. 监控精度

#### 延迟监控
- **测量精度**：毫秒级（0.001 秒）
- **更新频率**：可配置（0.5s - 5s）
- **响应时间**：实时响应，无延迟

#### 网络监控
- **速度精度**：三位小数（0.001 MB/s）
- **数据更新**：每次监控周期更新
- **异常检测**：自动检测和处理异常数据

### 2. 资源占用

#### 内存使用
- **基础占用**：约 10-20 MB
- **监控状态**：动态调整，根据活跃监控数量
- **资源清理**：自动清理，防止内存泄漏

#### CPU 使用
- **空闲状态**：接近 0%
- **监控状态**：根据监控频率和网络状态
- **优化策略**：智能调度，减少不必要的计算

## 总结

Moni 通过现代化的架构设计、优化的代码结构和丰富的功能特性，为用户提供了完整的网络监控解决方案。无论是 AI 服务开发者、网络管理员还是普通用户，都能从中获得价值。

项目的持续优化和改进确保了代码质量、性能和用户体验的不断提升，使其成为一个可靠、高效的 macOS 网络监控工具。
